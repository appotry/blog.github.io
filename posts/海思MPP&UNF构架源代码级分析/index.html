<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"> <script src="//cdn.jsdelivr.net/npm/@waline/client"></script><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="海思MPP&amp;UNF构架源代码级分析" /><meta name="author" content="appotry" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="海思MPP&amp;UNF构架源代码级分析" /><meta property="og:description" content="海思MPP&amp;UNF构架源代码级分析" /><link rel="canonical" href="https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/" /><meta property="og:url" content="https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/" /><meta property="og:site_name" content="夜法之书" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-30T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="海思MPP&amp;UNF构架源代码级分析" /><meta name="twitter:site" content="@firedingden" /><meta name="twitter:creator" content="@appotry" /><meta name="google-site-verification" content="zyYITwxtkHO52u3bhBQY05ycKt1Ywo8ePX5RDNFLXq0" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"appotry"},"description":"海思MPP&amp;UNF构架源代码级分析","url":"https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/","@type":"BlogPosting","headline":"海思MPP&amp;UNF构架源代码级分析","dateModified":"2021-08-20T21:10:06+08:00","datePublished":"2021-07-30T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/"},"@context":"https://schema.org"}</script><title>海思MPP&UNF构架源代码级分析 | 夜法之书</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="夜法之书"><meta name="application-name" content="夜法之书"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2440352_ruc9dk8lg2a.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2451185_tgvgeuen2lh.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">夜法之书</a></div><div class="site-subtitle font-italic">做一个深度思考的人</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="iconfont icon-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/subdomain/" class="nav-link"> <i class="iconfont icon-buywebhostingstep1domain ml-xl-3 mr-xl-3 unloaded"></i> <span>子域</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="iconfont icon-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="iconfont icon-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="iconfont icon-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="iconfont icon-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/appotry" aria-label="github" class="order-3" target="_blank" rel="noopener" > <i class="iconfont icon-github"></i> </a> <a href="https://twitter.com/firedingden" aria-label="twitter" class="order-4" target="_blank" rel="noopener" > <i class="iconfont icon-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['andycrusoe','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="iconfont icon-mail"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="iconfont icon-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle iconfont icon-adjust1"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>海思MPP&UNF构架源代码级分析</span> </span> <i id="sidebar-trigger" class="iconfont icon-bars"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="iconfont icon-search"></i> <span id="search-wrapper" class="align-items-center"> <i class="iconfont icon-search"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="iconfont icon-times-circle" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>海思MPP&UNF构架源代码级分析</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> 17lai.fun </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2021-07-30, 00:00 +0800" >07-30<i class="unloaded">2021-07-30T00:00:00+08:00</i> </span></div><div> <span> 更新于 <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2021-08-20, 21:10 +0800" >08-20<i class="unloaded">2021-08-20T21:10:06+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="8058 字">44 分钟阅读</span></div></div><div class="post-content"><ul><li><p>文章写了好多年了，只在一个网站发布过PDF版本。行业内应该很多人看过这个。由于早期笔记使用Word格式，转换格式时有不少格式错误，笔者尽量修正。</p><li>关于本blog，<strong>图床</strong>一般使用<strong>github</strong>，已经配置了CDN，如果图片还是未显示请自行代理解决<li><strong>原创声明警告</strong>，文章<strong>禁止转载</strong>，禁止发布到其它任何网站，可以接受约稿。</ul><p>最新修正日期： 20210820</p><h1 id="前言">前言：</h1><p>​ 本文通过分析海思文档和代码，把海思SDK的MPI和UNF构架大概实现思想和构架进行了简略的分析。着重分析了内存管理，底层功能如何实现。</p><p>​ 前面章节简要分析了NVR芯片MPI构架及其内存管理机制，后面着重详细分析了3798M底层模块api和drv实现的细节过程及其方法流程。</p><p>​ 本文前面简略分析了DVR，MPI构架的大体实现机制。后面就具体分析3798M UNF构架的实现。</p><p>本文不光分析了UNF构架，还使用了很多工具，辅助分析代码。这里从三个层面分析了UNF的实现。</p><p>1: 应用层，驱动层的实现框架，使用source insight查看代码并着重分析了avplay等几个模块。</p><p>2：静态分析函数调用。使用cflow，dot工具生成调用关系图</p><p>3：动态追踪运行过程。Ltrace, strace, valgrind分析函数调用，perf动态分析内核调用。</p><h1 id="1hi35xx系列芯片mpp构架">1:Hi35xx系列芯片MPP构架</h1><h2 id="11-概述">1.1 概述</h2><p>海思提供的媒体处理软件平台(Media Process Platform,简称 MPP)，可支持应用软件快速开发。该平台对应用软件屏蔽了芯片相关的复杂的底层处理，并对应用软件直接提供MPI（MPP Programe Interface）接口完成相应功能。该平台支持应用软件快速开发以下功能：输入视频捕获、H.264/MJPEG/JPEG/MPEG4 编码、H264/H.265/VC1/MPEG4/MPEG2/AVS 解码、视频输出显示、视频图像前处理（包括去噪、增强、锐化、Deinterlace） 、编码码流叠加 OSD、视频侦测分析、智能分析、音频捕获及输出、音频编解码等功能。</p><h2 id="12-整体软硬件构架">1.2 整体软硬件构架</h2><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730160509.png" alt="image-20210730160508049" /></p><p>MPP 平台支持的典型的系统层次如上图所示，主要分为以下层次：</p><p><strong>硬件层</strong></p><p>硬件层由 Hi35xx 芯片加上必要的外围器件构成。外围器件包括 Flash、DDR （Double Data-Rate） 、视频 Sensor 或 AD、音频 AD 等。</p><p><strong>操作系统层</strong></p><p>基于 Linux 3.10.y 的 OS 系统。</p><p><strong>媒体处理平台</strong></p><p>基于操作系统层，控制芯片完成相应的媒体处理功能。它对应用层屏蔽了硬件处理细节，并为应用层提供 API 接口完成相应功能。</p><p><strong>其他驱动</strong></p><p>除媒体处理平台外,海思为 Hi35xx 芯片的其他相关硬件处理单元提供了相应的驱动,</p><p>包括 GMAC、SDIO、I2C、USB、SSP 等驱动。</p><p><strong>应用层</strong></p><p>基于海思媒体处理平台及其他驱动，由用户开发的应用软件系统。</p><h2 id="13-海思媒体处理平台架构">1.3 海思媒体处理平台架构</h2><p>海思媒体处理平台的主要内部处理流程如上图所示，主要分为视频输入（VI） 、视频处理（VPSS） 、视频编码（VENC） 、视频解码（VDEC） 、视频输出(VO)、视频侦测分析(VDA)、音频输入(AI)、音频输出(AO)、音频编码（AENC） 、音频解码（ADEC） 、区域管理（REGION）等模块。主要的处理流程介绍如下</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730160451.png" alt="image-20210730160449679" /></p><ul><li><p>VI 模块捕获视频图像，可对其做剪切、缩放、镜像等处理，并输出多路不同分辨 率的图像数据。</p><li><p>解码模块对编码后的视频码流进行解码，并将解析后的图像数据送 VPSS 进行图 像处理或直接送 VO 显示。可对 H.264/H.265/VC1/MPEG4/MPEG2/AVS 格式的视 频码流进行解码。</p><li><p>VPSS 模块接收 VI 和解码模块发送过来的图像，可对图像进行去噪、图像增强、 锐化等处理，并实现同源输出多路不同分辨率的图像数据用于编码、预览或抓 拍。</p><li><p>编码模块接收 VI 捕获并经 VPSS 处理后输出的图像数据，可叠加用户通过 Region 模块设置的 OSD 图像，然后按不同协议进行编码并输出相应码流。 VDA 模块接收 VI 的输出图像，并进行移动侦测和遮挡侦测，最后输出侦测分析 结果。</p><li><p>VO 模块接收 VPSS 处理后的输出图像，可进行播放控制等处理，最后按用户配置 的输出协议输出给外围视频设备。</p><li><p>AI 模块捕获音频数据，然后 AENC 模块支持按多种音频协议对其进行编码，最后 输出音频码流。</p><li><p>用户从网络或外围存储设备获取的音频码流可直接送给 ADEC 模块，ADEC 支持</p></ul><h2 id="14-mmz与模块绑定">1.4 MMZ与模块绑定</h2><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730160438.png" alt="image-20210730160437079" /></p><p>MPP 提供系统绑定接口（HI_MPI_SYS_Bind） ，即通过数据接收者绑定数据源来建立</p><p>两者之间的关联关系（只允许数据接收者绑定数据源） 。绑定后，数据源生成的数据将</p><p>自动发送给接收者。</p><p>Uboot环境变量中定义linux内核使用的内存大小</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>setenv <span class="s1">'mem=288M console=ttyAMA0,115200 root=/dev/mtdblock2 rootfstype=jffs2 mtdparts=hi_sfc:768K(boot),2304K(sdr021000),13M(rootfs)'</span>
</pre></table></code></div></div><p>加载内核模块分配MMZ内存大小</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>insmod mmz.ko <span class="nv">mmz</span><span class="o">=</span>anonymous,0,0x8E000000,792M <span class="nv">anony</span><span class="o">=</span>1
</pre></table></code></div></div><p>例如512M的DDR</p><p>DDR:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    DDR:                                                          
    <span class="nt">-----------</span>|----------|  0x80000000   <span class="c"># Memory managed by OS.             </span>
       64M     |   OS     |                                                
               |          |                                                
    <span class="nt">-----------</span>|----------|  0x84000000   <span class="c"># Memory managed by MMZ block anonymous.         </span>
       448M    |    MMZ   |                                                
               |          |                                                
    <span class="nt">-----------</span>|----------|  0xA0000000   <span class="c"># Memory managed by MMZ block jpeg.                      </span>
</pre></table></code></div></div><h2 id="15-himpp-支持的绑定关系">1.5 HiMPP 支持的绑定关系</h2><div class="table-wrapper"><table><thead><tr><th>数据源<th>数据接收者<tbody><tr><td>VI<td>VO<tr><td> <td>VENC<tr><td> <td>VDA<tr><td> <td>VPSS<tr><td> <td>PCIV<tr><td>VPSS<td>VO<tr><td> <td>VENC<tr><td> <td>VDA<tr><td> <td>VPSS<tr><td> <td>PCIV<tr><td>VDEC<td>VPSS<tr><td> <td>VO（只能是标清设备或 single 模式分割）<tr><td> <td>VDA<tr><td> <td>PCIV<tr><td>vo(WBC)<td>VO<tr><td> <td>VENC<tr><td> <td>VPSS<tr><td> <td>PCIV<tr><td>AI<td>AENC<tr><td> <td>AO<tr><td>ADEC<td>AO</table></div><h2 id="16-函数约定说明">1.6 函数约定说明</h2><ul><li><p>Open/Close Open/Close 操作用来打开、关闭那些可枚举的设备。</p><li><p>Create/ Destroy Create/ Destroy 操作用来创建、销毁那些不可枚举的设备。</p><li><p>Handle Handle 用来标识一个“不可枚举”类型的设备。Handle 只在本进程内有效，也就是说 Handle 不可以跨进程传递Handle 是一个 32bit 的数据，其低 8bit 表示设备的 ID，高 16bit 表示模块 ID。比如0x00110000 表示模块 ID 为 0x11 的第 0 个设备。</p><li><p>Attach /Detach Attach/Detach 用来绑定、解绑定两个设备直接的关联。</p></ul><p>Attach 后，目的设备将自动处于 Start/Enable 状态； Detach 后，目的设备将自动处于Stop/Disable 状态。 对于多级绑定，<strong>要求从最后一个设备逐级向前绑定，解绑定的顺序则相反，要求逐级向后。</strong>** ** 当绑定在一起的多个设备可以设置相同属性时，必须通过最后一个设备进行设置。</p><ul><li><p>Get/Put Get/Put 用来往某个模块输入数据。</p><li><p>Acquire/Release Acquire/Release 用来从某个模块获取数据。</p></ul><p>Get/Put和Acquire/Release推荐成对使用</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155911.png" alt="image-20210730155909596" /></p><h2 id="17-mpp优缺点">1.7 MPP优缺点</h2><h2 id="171-mpp优点">1.7.1 MPP优点</h2><p>​ 内存VB管理和模块绑定子系统，proc运行时调试信息是MPP构架节约用户时间最大的设计。</p><p>​ 大部分外围接口都封装好，用户调用接口直接使用，快速，方便。</p><h2 id="172-mpp缺点">1.7.2 MPP缺点</h2><p>​ 没有相应子系统的源代码。出了问题，有bug必须需要海思查看，解决。</p><p>​ MPI接口和标准linux接口差异非常大，构架也不一样。有问题需要找海思。中间时间成本。</p><p>不利于研发技术积累。</p><h1 id="2--mpp和unf对比">2: MPP和UNF对比</h1><p>从函数命名，参数，使用方法来看。UNF和MPP分开比较早，UNF构架在上面函数约定说明基础上的MPI接口封装了一层，UNF-&gt;MPI调用，UNF开发支持更多的模块接口。MPP的模块接口比较固定，比UNF少得多，增强了MMZ内存，VB管理功能，模块绑定功能。</p><p>MPP由HI_MPI_SYS_Bind来绑定两个模块，而UNF还是使用Hi_XXX_Attach来绑定两个模块。</p><p>MPP内存管理MMZ，VB也比UNF更细致，强大。</p><p>UNF支持更多的外设模块。如TUNER（广播电视），CIPHER（芯片内部加密），Subtitle（字幕），PDM（低功耗），SCI（智能卡），GPU等。</p><p>UNF开源。在一些模块的实现中，也使用了一些开源项目，如FFmpeg，Alsa，wpa_supplicant等。</p><h1 id="3--3798芯片unf处理构架">3: 3798芯片UNF处理构架</h1><h1 id="31-应用架构">3.1 应用架构</h1><p>海思媒体处理平台（ MSP）实现了对海思高清机顶盒解决方案处理器中媒体、图形以 及外设的屏蔽和封装，对应用软件直接提供 API（ Application Program Interface）接口 完成相应功能。典型的应用架构如下图所示</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155841.png" alt="image-20210730155840578" /></p><p><strong>3798</strong><strong>比35xx</strong><strong>多了一个UNF</strong><strong>层，它在MPI</strong><strong>基础上进行了一层封装</strong></p><p>软件架构主要包含以下 4 层：</p><ul><li><p>UNF层</p><p>媒体处理平台（ MSP）对外统一的应用开发接口。</p><li><p>MPI层</p><p>处理器各模块硬件能力实现层的用户态部分。</p><li><p>DRV层</p><p>处理器各模块硬件能力实现层的内核态部分。</p><li><p>HAL层</p><p>处理器各模块的硬件抽象层。</p></ul><h1 id="32-3798sdk-概览功能介绍">3.2 3798SDK 概览（功能介绍）</h1><p>媒体处理平台（ MSP）中所有模块按照功能可以分为媒体处理，图形处理，外设处理 3 类：</p><ul><li><p>媒体处理</p><p>DEMUX、 AVPLAY、 SOUND、 DISPLAY、 VO、 HDMI、 PVR、 VDEC、 VENC、 ADEC、 AENC、 VI、 AI</p><li><p>图形处理</p><p>HIFB、 HIGO、 TDE、 JPEG、 JPGE、 GPU</p><li><p>外设处理</p><p>Cipher、 OTP、 PMOC、 Frontend、 I2C、 SCI、 KEYLED、 GPIO、 IR、 WDG、 C51</p></ul><h1 id="33-3798内存管理">3.3 3798内存管理</h1><h2 id="331-mmz内存">3.3.1 Mmz内存</h2><p>3798的mmz内存在uboot bootargs环境变量中分配，在内核中大块连续内存使用dma_alloc_from_contiguous（drv/mmz/drv_media_mem_v2.c）来分配内存， 小块内存使用kmalloc分配，并且使用内核链表标记管理。和应用层交互使用mamp，umamp，并使用内核链表管理内存。这点和35xx DVR芯片有很大区别，DVR芯片模块内存和linux内核使用内存不再一个地方，应该是通过物理地址往虚拟地址映射来使用的。</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># cat /proc/cmdline</span>
<span class="nv">mem</span><span class="o">=</span>1G <span class="nv">console</span><span class="o">=</span>ttyAMA0,115200 <span class="nv">root</span><span class="o">=</span>/dev/romblock3 <span class="nv">rootfstype</span><span class="o">=</span>squashfs <span class="nv">mtdparts</span><span class="o">=</span>hinand:5M<span class="o">(</span>boot<span class="o">)</span>,1M<span class="o">(</span>baseparam<span class="o">)</span>,7M<span class="o">(</span>kernel<span class="o">)</span>,18M<span class="o">(</span>rootfs<span class="o">)</span>,64M<span class="o">(</span>appfs<span class="o">)</span>,16M<span class="o">(</span>qte<span class="o">)</span>,4M<span class="o">(</span>config<span class="o">)</span>,12M<span class="o">(</span>log<span class="o">)</span>,1M<span class="o">(</span>logo<span class="o">)</span> <span class="nv">mmz</span><span class="o">=</span>ddr,0,0,500M
</pre></table></code></div></div><p>具体就是在bootargs中配置mem=1G mmz=ddr,0,0,435M</p><p>查看内存使用情况跟监控相同，通过cat /proc/media-mem</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155600.png" alt="image-20210730155558827" /></p><h2 id="332-解码vid内存">3.3.2 解码vid内存</h2><p>关于码流解码过程中视频缓冲buffer u32VidBufSize配置：</p><p>创建avplay时，可以指定视频es buf大小，参考如下代码</p><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>        <span class="n">Ret</span> <span class="o">=</span> <span class="n">HI_UNF_AVPLAY_GetDefaultConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">AvplayAttr</span><span class="p">,</span> <span class="n">HI_UNF_AVPLAY_STREAM_TYPE_ES</span><span class="p">);</span>
        <span class="n">AvplayAttr</span><span class="p">.</span><span class="n">stStreamAttr</span><span class="p">.</span><span class="n">u32VidBufSize</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
        <span class="n">Ret</span> <span class="o">|=</span> <span class="n">HI_UNF_AVPLAY_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">AvplayAttr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hAvplay</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</pre></table></code></div></div><p>Es buf的作用存储码流原始es流。</p><p>这个buffer的大小跟码流分辨率、码率都有关系，一般情况下，D1/720P/1080P/4K 码流的配置为 2M/3M/5M/16M 即可，特殊码流除外。</p><h1 id="34-3798模块">3.4 3798模块</h1><h3 id="demux">DEMUX：</h3><p>​ 数据输入模块。IF，TSI，RAM。</p><p>​ NVR使用的是RAM接口输入ES码流。</p><h3 id="vi">VI:</h3><p>虚拟VI</p><h3 id="vdec">VDEC</h3><p>​ 解码器模块提供一组函数指针，供解码使用。目前有264，mpeg4两个。</p><p>视频解码的简单流程是： 步骤 1 VDEC 从 Demux 或 ES buffer 获取 ES 数据送 Firmware 进行解码（ Firmware: StreamInput(VDEC-&gt;Firmware)）。 步骤 2 Firmware 将解码完的 1D 或者 2D 帧存放在帧 buffer 中。 步骤 3 VDEC 从帧 buffer 中获取（ Firmware: Frame Output(Firmware-&gt;VDEC)）视频帧放入其帧队列中。 步骤 4 VPSS 在线程中从 VDEC 的帧队列中取帧做解码后处理（ Frame Output(VDEC-&gt;VPSS)）。 步骤 5 AVPLAY 向 VDEC 获取视频帧， VDEC 从 VPSS 获取视频帧返回给 AVPLAY。</p><h3 id="sync">SYNC：</h3><p>音视频同步工具</p><h3 id="display显示设备">DISPLAY：显示设备</h3><h3 id="window显示通道">WINDOW：显示通道</h3><p>msp 目录下的“ windowXXYY”节点的中的 XX 为显示通道的编号， YY 为 window 序号。比如 window0100， bit[15:8]的 01 表示该 window 基于 DISPLAY1 创建， bit[7:0]的00 表示 window 序号为 0。有支持3D显示</p><p>DISP（ Display）模块接收 WINDOW 提供的视频图像、 Frame Buffer 提供的图形画 面，进行图像叠加处理和图像色彩调节，并将叠加后图像通过多种视频输出端口输出 给显示设备；此外， DISP 支持获取视频输出端口上的包含视频和图形的完整图像。</p><p>窗口类型</p><ul><li>Display：独立显示窗口<li>Virtual：虚拟窗口<li>Main：同源显示主窗口<li>Slave：同源显示从窗口</ul><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155307.png" alt="image-20210730155305921" /></p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155256.png" alt="image-20210730155254877" /></p><h3 id="so-subtitle-output">SO（ Subtitle Output）</h3><h3 id="pdm">PDM</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155248.png" alt="image-20210730155247422" /></p><p>PDM(Product Data Manager)模块用于管理与产品相关的数据，包括基本参数、开机画 面参数及数据、瞬播参数及数据的管理</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155410.png" alt="image-20210730155408819" /></p><p>用户通过镜像制作工具制作基本参数镜像与瞬播镜像，通过烧写工具烧写至 FLASH，PDM 模块在 BOOT 下将基本参数及瞬播数据读入内存，并传递至 KERNEL。 KERNEL下瞬播从 PDM 模块获取参数及数据，调用 DEMUX、 VDEC、 VO 等模块驱动，完成瞬播播放</p><p>demux</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155234.png" alt="image-20210730155230706" /></p><p>DEMUX 模块接收 DEMOD 或内存中的 TS 流，按客户应用程序（下简称 APP）的设 置提取出其中的 SEC 数据、 PES 数据、 TS 数据、音频数据和视频数据。 APP 获取 SEC 数据、 PES 数据和 TS 数据进行处理。 AVPLAY 获取音频数据进行处理， VDEC 获 取视频数据进行处理。</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155217.png" alt="image-20210730155210711" /></p><p>AVPLAY 主要依赖 ADEC/VDEC/DEMUX 等模块，其向应用或中间件播放器提供基本 的播放业务相关接口。</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155202.png" alt="image-20210730155201373" /></p><h1 id="35-3798和nvr模块使用方面区别">3.5 3798和NVR模块使用方面区别：</h1><p>3798模块中vpss，sync等模块是其它模块自动创建，自动绑定处理的。这点和NVR系列芯片差别很大，nvr中vi，vpss，vo都需要用户自己绑定，设置属性，而3798中vpss，vo创建，属性设置是在上层模块中自动处理的（少量设置属性上层传递下去）。</p><p>​ 简单来说，MPP接口只实现了基本的功能接口，没有封装或很少封装。</p><p>UNF 应用层实现了很多业务接口，对底层驱动进行了多层封装，并且实现了一些常用的业务。</p><h1 id="4-3798代码祥看">4: 3798代码祥看</h1><h1 id="41-分析方法">4.1 分析方法</h1><h2 id="411查看代码静态分析应用层驱动层实现方法">4.1.1：查看代码，静态分析应用层，驱动层实现方法</h2><p>​ 使用Source insight分析kernel，msp代码。</p><h2 id="412图示静态分析函数调用关系">4.1.2：图示静态分析函数调用关系</h2><p>​ 使用cflow， tree2dotx，和dot生成函数静态调用图。</p><h2 id="413图示动态分析函数调用关系库函数系统调用内核调用">4.1.3：图示动态分析函数调用关系：库函数，系统调用，内核调用</h2><ul><li>​ 使用ltrace分析系统库函数<li>​ strace分析系统调用流程<li>​ 使用Ftrace，valgrind，gprof2dot生成运行时调用图。<li>​ Perf分析内核空间调用。发现一些依赖库在ubuntu12.04里面不可用。</ul><p>这一步实现了valgrind动态分析，其它的几个工具需要交叉编译，TODO。使用Perf可能需要换更新的linux版本。</p><p>其它还有time(大概运行时间)，gconv（覆盖率统计）等分析方式。</p><h1 id="42-基础模块hi_media-hi_mmz-hi_common">4.2 基础模块：hi_media hi_mmz hi_common</h1><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155123.png" alt="image-20210730155121621" /></p><p>​ 可以从lsmod中很清晰的看出来hi_media hi_mmz hi_common这几个模块的基础地位。hi_media基础模块管理，hi_mmz提供内存管理，hi_common提供proc，log等基础功能，符号导出供其他海思模块使用。</p><p>Common</p><ul><li>COMMON 模块是 SDK 的基础模块，提供的 API 主要供 SDK 的其他模块调用。 COMMON 模块现在主要有以下功能：<ul><li>系统初始化和去初始化；<li>版本信息获取；<li>获取时间戳；<li>寄存器读写、映射功能；<li>MMZ 内存使用；<li>调试信息控制；<li>Flash 操作。</ul></ul><h2 id="421-基本通用模块应用层接口commonapi">4.2.1 基本通用模块应用层接口common/api</h2><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="n">HiSTBLinuxFS</span><span class="o">/</span><span class="n">source</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">api</span>
<span class="n">mpi_mem</span><span class="p">.</span><span class="n">c</span>
<span class="n">MEM_POOL_Init</span> <span class="err">应用层的内存池，重复利用。</span>
<span class="n">mpi_memmap</span><span class="p">.</span><span class="n">c</span>
<span class="err">映射使用链表区分。管理</span><span class="n">mmap</span><span class="err">映射</span>
 
 
<span class="n">mpi_module</span><span class="p">.</span><span class="n">c</span>
<span class="n">HI_MODULE_Init</span><span class="err">中有打开内存操作，内存统一管理。</span>
<span class="err">模块</span><span class="n">id</span><span class="err">，名称注册，相互查找。</span>
 
<span class="n">mpi_stat</span><span class="p">.</span><span class="n">c</span>
<span class="err">线程时间归零，等相关处理</span>
 
<span class="n">hi_common</span><span class="p">.</span><span class="n">c</span>
<span class="n">proc</span><span class="err">，</span><span class="n">sys</span><span class="err">一些路径目录增删提供了用户层接口，</span><span class="n">mmz</span><span class="err">内存管理用户层接口</span>
 
<span class="n">mpi_userproc</span>
<span class="err">用户层提供线程</span> <span class="err">通用</span><span class="n">proc</span><span class="err">接口，</span><span class="n">proc</span><span class="err">读写是在其它模块内部实现的，函数指针形式</span>
 
 
<span class="err">注：</span><span class="n">himedia</span> <span class="err">相关模块是海思自己实现的内核子系统。有自己实现的总线，驱动，设备模型结构体。也是在标准</span><span class="n">linux</span><span class="err">模型基础上封装的。</span>
 
</pre></table></code></div></div><h2 id="422-基本通用模块驱动接口commondev">4.2.2 基本通用模块驱动接口common/dev</h2><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="n">HiSTBLinuxFS</span><span class="o">/</span><span class="n">source</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">dev</span>
<span class="n">drv_dev_ext_k</span><span class="p">.</span><span class="n">c</span> <span class="err">重要</span>
<span class="n">HI_DRV_DEV_Init</span> <span class="err">所有模块宏定义在这里，注册模块结构体在这里</span>
<span class="n">himedia</span><span class="p">.</span><span class="n">c</span> <span class="n">himedia_bash</span><span class="p">.</span><span class="n">c</span>     <span class="err">模块注册，注销基础函数</span>
<span class="cp">#define DYNAMIC_MINORS 128 </span><span class="cm">/* like dynamic majors */</span><span class="cp">            himedia主设备号218
</span><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">himedia_minors</span><span class="p">[</span><span class="n">DYNAMIC_MINORS</span> <span class="o">/</span> <span class="mi">8</span><span class="p">];</span>
 
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagPM_BASEDEV_S</span><span class="p">{</span>
    <span class="n">HI_S32</span>        <span class="n">id</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">HI_S8</span>    <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span>    <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span><span class="n">PM_BASEDEV_S</span><span class="p">;</span>
 
<span class="cp">#define TO_PM_BASEDEV(x) container_of((x), PM_BASEDEV_S, dev)
</span> 
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagPM_BASEOPS_S</span> <span class="p">{</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_VOID</span> <span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">prepare</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_VOID</span> <span class="p">(</span><span class="o">*</span><span class="n">complete</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">suspend_late</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">resume_early</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
<span class="p">}</span><span class="n">PM_BASEOPS_S</span><span class="p">;</span>
 
 
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagPM_BASEDRV_S</span> <span class="p">{</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)</span> <span class="p">(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_VOID</span> <span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">suspend_late</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">resume_early</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">HI_S32</span>  <span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">device_driver</span> <span class="n">driver</span><span class="p">;</span>
<span class="p">}</span><span class="n">PM_BASEDRV_S</span><span class="p">;</span>
 
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagPM_DEVICE_S</span>  <span class="p">{</span>
    <span class="n">HI_S32</span> <span class="n">minor</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">HI_S8</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">app_ops</span><span class="p">;</span>
    <span class="n">PM_BASEOPS_S</span> <span class="o">*</span><span class="n">base_ops</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">app_device</span><span class="p">;</span>
    <span class="n">PM_BASEDEV_S</span> <span class="o">*</span><span class="n">base_device</span><span class="p">;</span>
    <span class="n">PM_BASEDRV_S</span> <span class="o">*</span><span class="n">base_driver</span><span class="p">;</span>
<span class="p">}</span><span class="n">PM_DEVICE_S</span><span class="p">;</span>
 
<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">himedia_class</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">himedia_fops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">owner</span>        <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span>        <span class="o">=</span> <span class="n">himedia_open</span><span class="p">,</span>
<span class="p">};</span>
 
</pre></table></code></div></div><h3 id="设备模型结构体">设备模型结构体</h3><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">himedia_devobj</span> <span class="p">{</span>
    <span class="n">PM_BASEDEV_S</span> <span class="n">pdev</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>
 
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagPM_BASEDEV_S</span><span class="p">{</span>
    <span class="n">HI_S32</span>        <span class="n">id</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">HI_S8</span>    <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span>    <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span><span class="n">PM_BASEDEV_S</span><span class="p">;</span>
 
</pre></table></code></div></div><h3 id="海思模块顶层总线himedia_bus">海思模块顶层总线himedia_bus</h3><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">device</span> <span class="n">himedia_bus</span> <span class="o">=</span> <span class="p">{</span>    <span class="p">.</span><span class="n">init_name</span>    <span class="o">=</span> <span class="s">"himediaBusDev"</span><span class="p">,</span>    <span class="p">.</span><span class="n">release</span>    <span class="o">=</span> <span class="n">himedia_bus_release</span><span class="p">};</span>  <span class="cm">/*top level bus, parent and bus member are both NULL*//*CNcomment:这是顶层总线，parent 和 bus 成员为 NULL*/</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">himedia_bus_type</span> <span class="o">=</span> <span class="p">{</span>    <span class="p">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s">"himediaBus"</span><span class="p">,</span>    <span class="p">.</span><span class="n">dev_attrs</span>    <span class="o">=</span> <span class="n">himedia_dev_attrs</span><span class="p">,</span>    <span class="p">.</span><span class="n">match</span>        <span class="o">=</span> <span class="n">himedia_match</span><span class="p">,</span>    <span class="p">.</span><span class="n">uevent</span>        <span class="o">=</span> <span class="n">himedia_uevent</span><span class="p">,</span>    <span class="p">.</span><span class="n">pm</span>            <span class="o">=</span> <span class="n">HIMEDIA_PM_OPS_PTR</span><span class="p">,};</span> <span class="err">定义</span><span class="n">HIMEDIA_PM_OPS_PTR</span>            <span class="k">static</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">himedia_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>                <span class="p">.</span><span class="n">prepare</span>        <span class="o">=</span> <span class="n">himedia_pm_prepare</span><span class="p">,</span>                <span class="p">.</span><span class="n">complete</span>       <span class="o">=</span> <span class="n">himedia_pm_complete</span><span class="p">,</span>                <span class="p">.</span><span class="n">suspend</span>        <span class="o">=</span> <span class="n">himedia_pm_suspend</span><span class="p">,</span>                <span class="p">.</span><span class="n">resume</span>         <span class="o">=</span> <span class="n">himedia_pm_resume</span><span class="p">,</span>                <span class="p">.</span><span class="n">freeze</span>         <span class="o">=</span> <span class="n">himedia_pm_freeze</span><span class="p">,</span>                <span class="p">.</span><span class="n">thaw</span>           <span class="o">=</span> <span class="n">himedia_pm_thaw</span><span class="p">,</span>                <span class="p">.</span><span class="n">poweroff</span>       <span class="o">=</span> <span class="n">himedia_pm_poweroff</span><span class="p">,</span>                <span class="p">.</span><span class="n">restore</span>        <span class="o">=</span> <span class="n">himedia_pm_restore</span><span class="p">,</span>                <span class="p">.</span><span class="n">suspend_noirq</span>  <span class="o">=</span> <span class="n">himedia_pm_suspend_noirq</span><span class="p">,</span>                <span class="p">.</span><span class="n">resume_noirq</span>   <span class="o">=</span> <span class="n">himedia_pm_resume_noirq</span><span class="p">,</span>                <span class="p">.</span><span class="n">freeze_noirq</span>   <span class="o">=</span> <span class="n">himedia_pm_freeze_noirq</span><span class="p">,</span>                <span class="p">.</span><span class="n">thaw_noirq</span>     <span class="o">=</span> <span class="n">himedia_pm_thaw_noirq</span><span class="p">,</span>                <span class="p">.</span><span class="n">poweroff_noirq</span> <span class="o">=</span> <span class="n">himedia_pm_poweroff_noirq</span><span class="p">,</span>                <span class="p">.</span><span class="n">restore_noirq</span>  <span class="o">=</span> <span class="n">himedia_pm_restore_noirq</span><span class="p">,</span>            <span class="p">};</span>             <span class="err">#</span><span class="n">define</span> <span class="n">HIMEDIA_PM_OPS_PTR</span>    <span class="p">(</span><span class="o">&amp;</span><span class="n">himedia_dev_pm_ops</span><span class="p">)</span> 
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730154854.png" alt="image-20210730154852692" /></p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730154845.png" alt="image-20210730154843225" /></p><h3 id="内核到用户往用户空间写文件调试">内核到用户往用户空间写文件调试</h3><p>drv_file_ext.c 提供内核空间创建，读写用户空间文件函数，/mnt文件存储路径。提供了内核数据导出到用户空间的方法。</p><p>应该是echo * &gt; /proc/msp/** 这种调试方式的实现方式</p><h3 id="内核log日志">内核log日志</h3><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="n">drv_log_ioctl</span><span class="p">.</span><span class="n">h</span>  <span class="err">打印日志相关。</span>  <span class="err">这里日志位置可选</span><span class="mi">0</span><span class="o">:</span><span class="err">串口</span> <span class="mi">1</span><span class="o">:</span><span class="err">网络</span> <span class="mi">2</span><span class="o">:</span><span class="n">U</span><span class="err">盘</span>
<span class="cm">/*structure of mode log level */</span>
<span class="cm">/*CNcomment: 模块打印级别控制信息结构 */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">hiLOG_CONFIG_INFO_S</span>
<span class="p">{</span>
    <span class="n">HI_U8</span> <span class="n">ModName</span><span class="p">[</span><span class="mi">16</span><span class="o">+</span><span class="mi">12</span><span class="p">];</span>     <span class="cm">/*mode name 16 + '_' 1 + pid 10 */</span>
    <span class="n">HI_U8</span> <span class="n">u8LogLevel</span><span class="p">;</span>         <span class="cm">/*log level*//*CNcomment:  模块打印级别控制 */</span>
    <span class="n">HI_U8</span> <span class="n">u8LogPrintPos</span><span class="p">;</span>      <span class="cm">/*log output location, 0:serial port; 1:network;2:u-disk*//*CNcomment:  模块打印位置控制 0:串口 1:网络 2:U盘 */</span>
    <span class="n">HI_U8</span> <span class="n">u8UdiskFlag</span><span class="p">;</span>        <span class="cm">/* u-disk log flag */</span>
<span class="p">}</span><span class="n">LOG_CONFIG_INFO_S</span><span class="p">;</span>
 
 
<span class="n">hi_debug</span><span class="p">.</span><span class="n">h</span>    <span class="n">log</span><span class="err">调试级别</span>
<span class="cm">/**Default level of the output debugging information*/</span>
<span class="cm">/**CNcomment: 默认的调试信息输出级别*/</span>
<span class="cp">#define HI_LOG_LEVEL_DEFAULT HI_LOG_LEVEL_ERROR
</span> 
<span class="cm">/**Level of the output debugging information*/</span>
<span class="cm">/**CNcomment: 调试信息输出级别*/</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">hiLOG_LEVEL_E</span>
<span class="p">{</span>
    <span class="n">HI_LOG_LEVEL_FATAL</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>     <span class="cm">/**&lt;Fatal error. It indicates that a critical problem occurs in the system. Therefore, you must pay attention to it.*/</span>
                                  <span class="cm">/**&lt;CNcomment: 致命错误, 此类错误需要特别关注，一般出现此类错误代表系统出现了重大问题 */</span>
    <span class="n">HI_LOG_LEVEL_ERROR</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>     <span class="cm">/**&lt;Major error. It indicates that a major problem occurs in the system and the system cannot run.*/</span>
                                  <span class="cm">/**&lt;CNcomment: 一般错误, 一般出现此类错误代表系统出现了比较大的问题，不能再正常运行 */</span>
    <span class="n">HI_LOG_LEVEL_WARNING</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>     <span class="cm">/**&lt;Warning. It indicates that a minor problem occurs in the system, but the system still can run properly.*/</span>
                                  <span class="cm">/**&lt;CNcomment: 告警信息, 一般出现此类信息代表系统可能出现问题，但是还能继续运行 */</span>
    <span class="n">HI_LOG_LEVEL_INFO</span>    <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>     <span class="cm">/**&lt;Message. It is used to prompt users. Users can open the message when locating problems. It is recommended to disable this message in general.*/</span>
                                  <span class="cm">/**&lt;CNcomment: 提示信息, 一般是为提醒用户而输出，在定位问题的时候可以打开，一般情况下建议关闭 */</span>
    <span class="n">HI_LOG_LEVEL_DBG</span>     <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>     <span class="cm">/**&lt;Debug. It is used to prompt developers. Developers can open the message when locating problems. It is recommended to disable this message in general.*/</span>
                                  <span class="cm">/**&lt;CNcomment: 提示信息, 一般是为开发人员调试问题而设定的打印级别，一般情况下建议关闭 */</span>
 
    <span class="n">HI_LOG_LEVEL_BUTT</span>
<span class="p">}</span> <span class="n">HI_LOG_LEVEL_E</span><span class="p">;</span>
 
<span class="n">drv_media_mem_v2</span><span class="p">.</span><span class="n">c</span>    <span class="err">实现了</span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">media</span><span class="o">-</span><span class="n">mem</span>
 
<span class="n">drv_mem_ext</span><span class="p">.</span><span class="n">c</span> <span class="err">实现了</span> <span class="n">KMEM_POOL_S</span> <span class="err">的管理，</span>
 
 
</pre></table></code></div></div><h3 id="内核模块管理">内核模块管理</h3><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">drv_module_ext</span><span class="p">.</span><span class="n">cCOMMON_DRV_ModInit</span>    <span class="n">MMNGR_DRV_ModInit</span>     <span class="n">s32Ret</span> <span class="o">=</span> <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_SYS</span><span class="p">,</span>    <span class="s">"HI_SYS"</span><span class="p">,</span>      <span class="n">HI_NULL</span><span class="p">);</span>    <span class="n">s32Ret</span> <span class="o">|=</span> <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_MODULE</span><span class="p">,</span> <span class="s">"HI_MODULE"</span><span class="p">,</span>   <span class="n">HI_NULL</span><span class="p">);</span>    <span class="n">s32Ret</span> <span class="o">|=</span> <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_LOG</span><span class="p">,</span>    <span class="s">"HI_LOG"</span><span class="p">,</span>      <span class="n">HI_NULL</span><span class="p">);</span>    <span class="n">s32Ret</span> <span class="o">|=</span> <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_PROC</span><span class="p">,</span>   <span class="s">"HI_PROC"</span><span class="p">,</span>     <span class="n">HI_NULL</span><span class="p">);</span>    <span class="n">s32Ret</span> <span class="o">|=</span> <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_STAT</span><span class="p">,</span>   <span class="s">"HI_STAT"</span><span class="p">,</span>     <span class="n">HI_NULL</span><span class="p">);</span>    <span class="n">s32Ret</span> <span class="o">|=</span> <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_MEM</span><span class="p">,</span>    <span class="s">"HI_MEM"</span><span class="p">,</span>      <span class="n">HI_NULL</span><span class="p">);</span> <span class="n">drv_media_mem</span><span class="p">.</span><span class="n">c</span>     <span class="err">使用</span><span class="n">dma_alloc_from_contiguous</span><span class="err">来分配</span><span class="n">HI_DRV_MMZ_Init</span>    <span class="err">这里根据</span><span class="n">bootargs</span><span class="err">传递的</span><span class="n">mmz</span><span class="err">参数分配内存大小。</span> <span class="n">mmz</span><span class="err">分配时的参数：</span><span class="o">&lt;</span><span class="n">mmz_name</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">gfp</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">phys_start_addr</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">size</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">alloc_type</span><span class="o">&gt;</span><span class="s">"</span><span class="err">
</span></pre></table></code></div></div><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730154720.png" alt="image-20210730154718737" /></p><h3 id="内核proc的实现">内核Proc的实现</h3><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">drv_proc_ext</span><span class="p">.</span><span class="n">cHI_DRV_PROC_Init</span>    <span class="err">实现</span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">hisi</span><span class="o">/</span><span class="n">msp</span><span class="o">/</span>    <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">"graphics"</span><span class="p">,</span> <span class="n">g_pHisi_proc</span><span class="p">);</span>    <span class="n">proc_symlink</span><span class="p">(</span><span class="s">"msp"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"hisi/msp"</span><span class="p">);</span>    <span class="n">proc_symlink</span><span class="p">(</span><span class="s">"graphics"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"hisi/graphics"</span><span class="p">);</span> 
</pre></table></code></div></div><p>drv_userproc.c proc使用红黑树管理目录路径</p><p>​ 创建销毁目录，路径在这里实现，具体每一个不同模块的proc文件读写在每个模块内部实现，使用函数指针。</p><h3 id="423-业务模块应用层通用组件sourcecomponent">4.2.3 业务模块应用层通用组件source/component</h3><p>/home/andy/HiSTBLinuxFS/source/component 这个目录里面很多目录只有.so .a库，没有源代码。</p><p>/source/component/hiplayer 没有源码。</p><p>hi_debug.h 各种调试宏定义，不同级别调试定义</p><p>HI_MALLOC 内存分配使用了内核链表管理</p><p>内存在一个模块内分配，往用户空间传递物理地址，其它模块使用这个物理地址映射到虚拟地址，这样来共享内存</p><p>​ 海思这里大多数模块都只提供了编译后的库</p><h1 id="43-海思专用组件">4.3 海思专用组件</h1><h2 id="431-海思msp模块应用层接口sourcemspapi">4.3.1 海思MSP模块应用层接口source/msp/api</h2><h4 id="avplay分析">Avplay分析</h4><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">HI_MPI_AVPLAY_Create</span><span class="err">​</span>    <span class="n">AVPLAY_FrcCreate</span>  <span class="err">帧率控制？</span> <span class="err">​</span>    <span class="n">HI_MPI_SYNC_Create</span>   <span class="err">音视频同步​</span>    <span class="n">AVPLAY_CreateThread</span>
</pre></table></code></div></div><p>​ <img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730154354.svg" alt="HI_MPI_AVPLAY_Create.__avplay_mpi_avplay_c" /></p><p>上图插图的是svg格式图片，可以使用IE，firefox打开，最好使用专门的看图软件打开。</p><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">HI_MPI_VDEC_AllocChan</span>    <span class="nf">VPSS_Control</span><span class="p">(</span><span class="n">pstVdec</span><span class="o">-&gt;</span><span class="n">hVdec</span><span class="p">,</span><span class="n">VPSS_CMD_CREATEVPSS</span><span class="p">,</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pstVdec</span><span class="o">-&gt;</span><span class="n">hVpss</span><span class="p">))</span> <span class="n">UNF</span><span class="err">调用一般过程，最终采用</span><span class="n">ioctl</span><span class="err">调用驱动</span>   <span class="n">HI_UNF_AVPLAY_GetBuf</span>    <span class="n">HI_MPI_AVPLAY_GetBuf</span>        <span class="n">HI_MPI_VDEC_ChanGetBuffer</span>            <span class="n">VDEC_GetStreamBuf</span>        <span class="cm">/* If get but not put, return last address */</span>    <span class="err">这里有对不对称调用特殊处理</span>                <span class="n">ioctl</span><span class="p">(</span><span class="n">s_stVdecAdpParam</span><span class="p">.</span><span class="n">s32DevFd</span><span class="p">,</span> <span class="n">UMAPC_VDEC_GETBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stBufParam</span><span class="p">);</span>    <span class="n">HI_MPI_AVPLAY_Start</span>    <span class="n">AVPLAY_StartVidChn</span>        <span class="n">HI_MPI_SYNC_Start</span>        <span class="n">HI_MPI_VDEC_ChanStart</span>             <span class="nf">ioctl</span><span class="p">(</span><span class="n">g_SyncDevFd</span><span class="p">,</span> <span class="n">CMD_SYNC_START_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SyncId</span><span class="p">);</span>    <span class="n">HI_MPI_SYNC_Play</span>    <span class="err">结构体状态改变</span>    <span class="n">AVPLAY_Play</span>        <span class="err">结构体状态控制</span>    <span class="n">HI_MPI_STAT_Event</span>                <span class="n">HI_MPI_AVPLAY_Stop</span>    <span class="n">AVPLAY_StopVidChn</span>        <span class="n">HI_MPI_VDEC_ChanStop</span>            <span class="n">VDEC_ChanStop</span>    <span class="err">这里调用函数指针</span>        <span class="n">HI_MPI_VDEC_ResetChan</span>            <span class="n">VDEC_ResetStreamBuf</span>            <span class="nf">VDEC_VPSSCMD</span><span class="p">(</span><span class="n">hVdec</span><span class="p">,</span> <span class="n">VPSS_CMD_RESETVPSS</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">);</span>    <span class="err">调用函数指针，指向</span><span class="n">VPSS_Control</span>        <span class="n">AVPLAY_ResetWindow</span>        <span class="n">HI_MPI_SYNC_Stop</span>    <span class="nf">HI_MPI_STAT_Event</span><span class="p">(</span><span class="n">STAT_EVENT_VSTOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">VDEC</span><span class="err">使用函数指针集来支持多种解码方式，内部</span><span class="n">vfmw</span><span class="err">。</span><span class="n">mjpeg</span><span class="err">，内部硬件</span><span class="mi">265</span><span class="err">协处理器</span><span class="n">mpi_vdec_vpu</span><span class="p">.</span><span class="n">cHI_MPI_VDEC_Init</span>    <span class="nf">HI_CODEC_Register</span><span class="p">(</span><span class="n">VDEC_MJPEG_Codec</span><span class="p">());</span>    <span class="n">HI_CODEC_Register</span><span class="p">(</span><span class="n">VDEC_VFMW_Codec</span><span class="p">());</span> <span class="k">static</span> <span class="n">HI_CODEC_S</span> <span class="n">hi_codecVPU_entry</span> <span class="o">=</span><span class="p">{</span>    <span class="p">.</span><span class="n">pszName</span>        <span class="o">=</span> <span class="s">"VPU"</span><span class="p">,</span>    <span class="p">.</span><span class="n">unVersion</span>        <span class="o">=</span> <span class="p">{.</span><span class="n">stVersion</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>    <span class="p">.</span><span class="n">pszDescription</span> <span class="o">=</span> <span class="s">"Hisilicon H265 codec"</span><span class="p">,</span>     <span class="p">.</span><span class="n">GetCap</span>            <span class="o">=</span> <span class="n">HI_VPU_GetCap</span><span class="p">,</span>    <span class="p">.</span><span class="n">Create</span>            <span class="o">=</span> <span class="n">HI_VPU_Create</span><span class="p">,</span>    <span class="p">.</span><span class="n">Destroy</span>        <span class="o">=</span> <span class="n">HI_VPU_Destroy</span><span class="p">,</span>    <span class="p">.</span><span class="n">Start</span>            <span class="o">=</span> <span class="n">HI_VPU_Start</span><span class="p">,</span>    <span class="p">.</span><span class="n">Stop</span>            <span class="o">=</span> <span class="n">HI_VPU_Stop</span><span class="p">,</span>    <span class="p">.</span><span class="n">Reset</span>            <span class="o">=</span> <span class="n">HI_VPU_Reset</span><span class="p">,</span>    <span class="p">.</span><span class="n">SetAttr</span>        <span class="o">=</span> <span class="n">HI_VPU_SetAttr</span><span class="p">,</span>    <span class="p">.</span><span class="n">GetAttr</span>        <span class="o">=</span> <span class="n">HI_VPU_GetAttr</span><span class="p">,</span>    <span class="p">.</span><span class="n">DecodeFrame</span>    <span class="o">=</span> <span class="n">HI_VPU_DecodeFrame</span><span class="p">,</span>    <span class="p">.</span><span class="n">EncodeFrame</span>    <span class="o">=</span> <span class="n">HI_NULL</span><span class="p">,</span>    <span class="p">.</span><span class="n">RegFrameBuffer</span> <span class="o">=</span> <span class="n">HI_VPU_RegFrameBuffer</span><span class="p">,</span>    <span class="p">.</span><span class="n">GetStreamInfo</span>    <span class="o">=</span> <span class="n">HI_VPU_GetStreamInfo</span><span class="p">,</span>    <span class="p">.</span><span class="n">Control</span>        <span class="o">=</span> <span class="n">HI_VPU_Control</span><span class="p">,};</span> <span class="n">avplay</span><span class="err">，</span><span class="n">vi</span><span class="err">和</span> <span class="n">vo</span><span class="err">之间使用</span><span class="n">vpss</span><span class="err">关联。</span><span class="n">HI_UNF_VO_DetachWindow</span>    <span class="n">HI_MPI_AVPLAY_DetachWindow</span>        <span class="n">HI_MPI_VDEC_DestroyPort</span>    <span class="nf">HI_MPI_VI_Detach</span><span class="p">(</span><span class="n">hSrc</span><span class="p">,</span> <span class="n">hWindow</span><span class="p">);</span>        <span class="n">VI_DetachFromVpss</span> <span class="n">HI_MPI_AVPLAY_ChnClose</span>    <span class="n">AVPLAY_FreeVidChn</span>        <span class="n">HI_MPI_VDEC_ChanBufferDeInit</span>            <span class="nf">VDEC_VFMWSpecCMD</span><span class="p">(</span><span class="n">hVdec</span><span class="p">,</span> <span class="n">VFMW_CMD_DETACHBUF</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">);</span>            <span class="n">VDEC_DestroyStreamBuf</span><span class="p">(</span><span class="n">pstVdec</span><span class="o">-&gt;</span><span class="n">hStreamBuf</span><span class="p">);</span>        <span class="n">ummap</span><span class="err">内存块，</span><span class="n">ioctl</span><span class="err">通知内核</span><span class="n">vdec</span><span class="err">销毁内存</span>        <span class="n">AVPLAY_FreeVdec</span>            <span class="n">HI_MPI_VDEC_FreeChan</span>                <span class="nf">VPSS_Control</span><span class="p">(</span><span class="n">pstVdec</span><span class="o">-&gt;</span><span class="n">hVdec</span><span class="p">,</span><span class="n">VPSS_CMD_DESTORYVPSS</span><span class="p">,</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pstVdec</span><span class="o">-&gt;</span><span class="n">hVpss</span><span class="p">));</span>                <span class="n">VDEC_DestroyCodec</span><span class="p">(</span><span class="n">pstVdec</span><span class="p">);</span> <span class="n">HI_UNF_AVPLAY_Destroy</span>    <span class="n">HI_MPI_AVPLAY_Destroy</span>        <span class="nf">HI_MPI_SYNC_Destroy</span><span class="p">(</span><span class="n">pAvplay</span><span class="o">-&gt;</span><span class="n">hSync</span><span class="p">);</span>        <span class="n">ioctl</span><span class="p">(</span><span class="n">g_AvplayDevFd</span><span class="p">,</span> <span class="n">CMD_AVPLAY_DESTROY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AvplayUsrAddr</span><span class="p">.</span><span class="n">AvplayId</span><span class="p">);</span> <span class="n">avplay</span><span class="err">内部的线程</span>    <span class="p">(</span><span class="n">HI_VOID</span><span class="p">)</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">pAvplay</span><span class="o">-&gt;</span><span class="n">AvplayDataThdInst</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">);</span><span class="err">#</span><span class="n">ifdef</span> <span class="nf">AVPLAY_VID_THREAD</span>    <span class="p">(</span><span class="n">HI_VOID</span><span class="p">)</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">pAvplay</span><span class="o">-&gt;</span><span class="n">AvplayVidDataThdInst</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">);</span><span class="err">#</span><span class="n">endif</span>    <span class="p">(</span><span class="n">HI_VOID</span><span class="p">)</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">pAvplay</span><span class="o">-&gt;</span><span class="n">AvplayStatThdInst</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">);</span>          
</pre></table></code></div></div><h2 id="432-海思msp模块驱动层接口sourcemspdrv">4.3.2 海思MSP模块驱动层接口source/msp/drv/</h2><h3 id="venc">VENC</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730161000.png" alt="image-20210730154156590" /></p><p>VENC 模块的具体工作原理如上图所示，注意图中褐色箭头，是 VENC 调用到VPSS 模块，来对帧信息做缩放处理后编码的数据流，该处理只用于外部用户送帧的模式。若在绑定情况下出现帧信息分辨率与编码分辨率不匹配， VENC 模块会通知绑定的前级模块进行缩放处理，而不会自行调用 VPSS 模块缩放。</p><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">VENC_DRV_ModInit</span><span class="err">​</span>    <span class="n">VENC_DRV_Init</span><span class="err">​</span>         <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_VENC</span><span class="p">,</span> <span class="s">"HI_VENC"</span><span class="p">,</span> <span class="p">(</span><span class="n">HI_VOID</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s_VencExportFuncs</span><span class="p">);</span><span class="err">​</span>             <span class="n">MODULE_DRV_Register</span><span class="err">​</span>                 <span class="n">ModuleMgr_Link_AddNode</span><span class="p">(</span><span class="n">g_pstKModuleHeader</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stModule</span><span class="p">);</span>  <span class="err">链表管理​</span>                 <span class="n">LOGAddModule</span><span class="p">((</span><span class="n">HI_PCHAR</span><span class="p">)</span><span class="n">pu8ModuleName</span><span class="p">,</span> <span class="p">(</span><span class="n">HI_MOD_ID_E</span><span class="p">)</span><span class="n">u32ModuleID</span><span class="p">);</span>   <span class="err">在</span><span class="n">log</span><span class="err">模块中注册​</span>    <span class="n">HI_DRV_DEV_Register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_VencRegisterData</span><span class="p">)</span><span class="err">​</span>         <span class="n">HI_DRV_PM_Register</span>   <span class="err">海思模块管理非常重要的模块，了解这个函数实现过程就大概明白海思内核模块实现思想了​</span>    <span class="n">VENC_DRV_BoardDeinit</span><span class="p">();</span>   <span class="err">一些寄存器配置，</span><span class="n">reset</span><span class="err">，</span><span class="n">clock</span><span class="err">操作。​</span>    <span class="n">venc</span><span class="err">调用硬件协处理器，涉及</span><span class="mi">263</span><span class="p">,</span><span class="mi">264</span><span class="err">，</span><span class="n">mpeg4</span><span class="err">，​</span>      <span class="n">snprintf</span><span class="p">(</span><span class="n">g_VencRegisterData</span><span class="p">.</span><span class="n">devfs_name</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">UMAP_DEVNAME_VENC</span><span class="p">);</span>  <span class="n">g_VencRegisterData</span><span class="p">.</span><span class="n">fops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">VENC_FOPS</span><span class="p">;</span>  <span class="n">g_VencRegisterData</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">UMAP_MIN_MINOR_VENC</span><span class="p">;</span>  <span class="n">g_VencRegisterData</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>  <span class="n">g_VencRegisterData</span><span class="p">.</span><span class="n">drvops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">venc_drvops</span><span class="p">;</span>   
</pre></table></code></div></div><h3 id="avplay">avplay</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730154040.png" alt="image-20210730154038801" /></p><ul><li>AVPLAY 主要由以下三部分组成：<ul><li>音视频解码器<li>同步播放控制模块<li>命令与状态管理模块</ul></ul><p>主要负责响应外部控制命令的执行、状态查询上报、使解码后的帧数据通过同步控制 模块输出</p><h3 id="avplay初始化分析">avplay初始化分析</h3><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="n">AVPLAY_DRV_ModInit</span>
<span class="err">​</span>    <span class="n">HI_DRV_MODULE_Register</span>
<span class="err">​</span>         <span class="n">HI_DRV_MODULE_Register</span><span class="p">(</span><span class="n">HI_ID_AVPLAY</span><span class="p">,</span> <span class="n">AVPLAY_NAME</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">);</span>
<span class="err">​</span>             <span class="n">ModuleMgr_Link_AddNode</span>  <span class="err">内核模块管理</span>
<span class="err">​</span>             <span class="n">KMODULE_MEM_POOL_AddModule</span>
<span class="err">​</span>                 <span class="n">KMODULE_MEM_POOL_FindNode</span>    <span class="err">找到空的没有使用的节点</span>
<span class="err">​</span>                 <span class="n">KMODULE_MEM_POOL_MALLOC</span> <span class="err">分配内存，然后放到链表</span>
<span class="err">​</span>             <span class="n">LOGAddModule</span>                    <span class="err">日志</span>
<span class="err">​</span>    <span class="n">HI_DRV_DEV_Register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_AvplayRegisterData</span><span class="p">)</span>
<span class="err">​</span>         <span class="n">HI_DRV_PM_Register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_umap_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>   <span class="n">himedia</span><span class="err">封装处理</span>
<span class="err">​</span>             <span class="n">himedia_device_alloc</span><span class="p">(</span><span class="n">himedia</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="err">​</span>             <span class="n">himedia_device_add</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="err">​</span>                 <span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"%s.%d"</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="err">​</span>                 <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="err">​</span>             <span class="n">device_create</span><span class="p">(</span><span class="n">himedia_class</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">himedia</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="err">​</span>             <span class="n">himedia_driver_alloc</span><span class="p">(</span><span class="n">himedia</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">himedia</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">himedia</span><span class="o">-&gt;</span><span class="n">base_ops</span><span class="p">);</span>
<span class="err">​</span>             <span class="n">himedia_driver_register</span><span class="p">(</span><span class="n">bdrv</span><span class="p">);</span>
<span class="err">​</span>                 <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
<span class="err">​</span>   
 
  <span class="n">g_AvplayRegisterData</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">AVPLAY_FOPS</span><span class="p">;</span>
  <span class="n">g_AvplayRegisterData</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">UMAP_MIN_MINOR_AVPLAY</span><span class="p">;</span>
  <span class="n">g_AvplayRegisterData</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
  <span class="n">g_AvplayRegisterData</span><span class="p">.</span><span class="n">drvops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">AVPLAY_DRVOPS</span><span class="p">;</span>  
 
  <span class="n">s_umap_devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">minor</span> <span class="o">=</span> <span class="n">umapd</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
  <span class="n">s_umap_devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">umapd</span><span class="o">-&gt;</span><span class="n">devfs_name</span><span class="p">;</span>
  <span class="n">s_umap_devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">owner</span> <span class="o">=</span> <span class="n">umapd</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
  <span class="n">s_umap_devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_ops</span> <span class="o">=</span> <span class="n">umapd</span><span class="o">-&gt;</span><span class="n">fops</span><span class="p">;</span>
  <span class="n">s_umap_devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_ops</span> <span class="o">=</span> <span class="n">umapd</span><span class="o">-&gt;</span><span class="n">drvops</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="ioctl实现分析-基于avplay">IOCTL实现分析 基于avplay</h3><p>在HI_DRV_DEV_Register<strong>中注册</strong></p><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">AVPLAY_FOPS</span> <span class="o">=</span><span class="p">{</span>  <span class="p">.</span><span class="n">owner</span>     <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>  <span class="p">.</span><span class="n">open</span>      <span class="o">=</span> <span class="n">AVPLAY_DRV_Open</span><span class="p">,</span>  <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">AVPLAY_DRV_Ioctl</span><span class="p">,</span>  <span class="p">.</span><span class="n">release</span>    <span class="o">=</span> <span class="n">AVPLAY_DRV_Close</span><span class="p">,};</span>   <span class="n">AVPLAY_DRV_Ioctl</span><span class="err">​</span>    <span class="n">HI_DRV_UserCopy</span><span class="p">(</span><span class="n">ffile</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">ffile</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">AVPLAY_Ioctl</span><span class="p">);</span><span class="err">​</span>         <span class="n">func</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">parg</span><span class="p">));</span>     <span class="err">这里对</span><span class="n">ioctl</span><span class="err">进行了一层封装，</span><span class="n">copy_from_user</span><span class="err">，</span><span class="n">copy_to_user</span><span class="err">的自动化处理</span>   <span class="n">AVPLAY_Ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">HI_VOID</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>   <span class="err">​</span>         <span class="n">CMD_AVPLAY_CREATE</span>      <span class="err">​</span>             <span class="n">AVPLAY_Create</span><span class="err">​</span>                 <span class="n">HI_DRV_MMZ_AllocAndMap</span><span class="p">(</span><span class="n">BufName</span><span class="p">,</span> <span class="n">MMZ_OTHERS</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MemBuf</span><span class="p">);</span><span class="err">​</span>                 <span class="n">HI_DRV_PROC_AddModule</span><span class="p">(</span><span class="n">ProcName</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">,</span> <span class="n">HI_NULL</span><span class="p">);</span>         <span class="err">这里实现了</span><span class="n">proc</span><span class="err">目录的生成，下面是读写</span><span class="n">proc</span><span class="err">​</span>               <span class="n">pProcItem</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">AVPLAY_ProcRead</span><span class="p">;</span><span class="err">​</span>               <span class="n">pProcItem</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">AVPLAY_ProcWrite</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="avplay-多个实例如何找到对应实例">avplay 多个实例如何找到对应实例</h3><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">AVPLAY_GET_INST_AND_LOCK</span><span class="p">();</span> <span class="err">​</span>    <span class="n">AVPLAY_CheckHandle</span> <span class="err">​</span>         <span class="n">pAvplayUsrAddr</span><span class="o">-&gt;</span><span class="n">AvplayId</span> <span class="o">=</span> <span class="n">hAvplay</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="err">​</span>         <span class="n">ioctl</span><span class="p">(</span><span class="n">g_AvplayDevFd</span><span class="p">,</span> <span class="n">CMD_AVPLAY_CHECK_ID</span><span class="p">,</span> <span class="n">pAvplayUsrAddr</span><span class="p">);</span>
</pre></table></code></div></div><p>drv中的实现</p><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">AVPLAY_Ioctl</span>      <span class="err">​</span>    <span class="n">AVPLAY_CheckId</span>       <span class="err">​</span>         <span class="n">pAvplayUsrAddr</span><span class="o">-&gt;</span><span class="n">AvplayUsrAddr</span> <span class="o">=</span> <span class="n">g_AvplayGlobalState</span><span class="p">.</span><span class="n">AvplayInfo</span><span class="p">[</span><span class="n">pAvplayUsrAddr</span><span class="o">-&gt;</span><span class="n">AvplayId</span><span class="p">].</span><span class="n">AvplayUsrAddr</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="vpss">VPSS</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153749.png" alt="image-20210730153748255" /></p><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>  <span class="n">g_VpssRegisterData</span><span class="p">.</span><span class="n">fops</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">s_VpssFileOps</span><span class="p">;</span>
  <span class="n">g_VpssRegisterData</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">UMAP_MIN_MINOR_VPSS</span><span class="p">;</span>
  <span class="n">g_VpssRegisterData</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
  <span class="n">g_VpssRegisterData</span><span class="p">.</span><span class="n">drvops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s_VpssBasicOps</span><span class="p">;</span>
 
 
 
<span class="n">VPSS_DRV_Init</span>
<span class="n">VPSS_CTRL_Init</span>
<span class="err">​</span>    <span class="n">VPSS_CTRL_RegistISR</span>   <span class="err">注册中断</span>
<span class="err">​</span>    <span class="n">VPSS_CTRL_InitInstList</span><span class="p">((</span><span class="n">VPSS_IP_E</span><span class="p">)</span><span class="n">i</span><span class="p">)</span>   <span class="err">管理</span><span class="n">vpss</span><span class="err">实例链表初始化</span>
<span class="err">​</span>    <span class="n">VPSS_HAL_Init</span>     <span class="err">内存，寄存器配置</span>
<span class="err">​</span>    <span class="n">VPSS_CTRL_CreateThread</span>    <span class="err">内核线程</span>
<span class="err">​</span>         <span class="n">VPSS_CTRL_ThreadProc</span>
<span class="err">​</span>             <span class="n">VPSS_CTRL_CreateTask</span>      <span class="err">创建任务</span>
<span class="err">​</span>             <span class="n">VPSS_CTRL_StartTask</span>       <span class="err">开始任务</span>
</pre></table></code></div></div><h3 id="vdec-1">VDEC</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153702.png" alt="image-20210730153700720" /></p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153709.png" alt="image-20210730153708541" /></p><h3 id="avplay解码es流过程">Avplay解码ES流过程</h3><p>步骤 1 初始化并配置相关设备，如 DISPLAY、 VO、 SOUND、 DEMUX 设备等。 步骤 2 调用 HI_UNF_AVPLAY_Init 接口初始化 AVPLAY 设备。 步骤 3 调用 HI_UNF_AVPLAY_GetDefaultConfig 接口获取缺省的 AVPLAY 配置，注意选择HI_UNF_AVPLAY_STREAM_TYPE_ES 模式。 步骤 4 根据应用需要，修改码流属性参数。 步骤 5 调用 HI_UNF_AVPLAY_Create 接口创建 AVPLAY 播放器。 步骤 6 调用 HI_UNF_AVPLAY_ChnOpen 接口打开音频或视频通道。</p><p>步骤 7 调用 HI_UNF_AVPLAY_SetAttr 接口设置音频解码器或视频解码器属性，同步设置为自由播放。 步骤 8 调用 HI_UNF_SND_CreateTrack 创建 Track。 步骤 9 调用 HI_UNF_SND_Attach 接口将音频播放器与 Track 绑定。 步骤 10 调用 HI_UNF_VO_AttachWindow 接口将视频播放器与 VO 的窗口绑定。 步骤 11 调用 HI_UNF_VO_SetWindowEnable 接口使能窗口。 步骤 12 调用 HI_UNF_AVPLAY_Start 接口发送 Start 命令，开始播放音频或视频。 步骤 13 调用 HI_UNF_AVPLAY_GetBuf 接口申请存放音频或视频的缓冲区。 步骤 14 通过内存拷贝或文件读取等方式，将音频或视频数据直接写到缓冲区中。 步骤 15 调用 HI_UNF_AVPLAY_PutBuf 接口更新音视频缓冲区中的读写指针。 步骤 16 播放任务结束后，首先调用 HI_UNF_AVPLAY_Stop 接口停止 AVPLAY，再调用HI_UNF_AVPLAY_Destroy 接口销毁 AVPLAY，释放相关资源。 步骤 17 关闭相关设备，如 DISPLAY 设备、 VO 设备、 SOUND 设备、 DEMUX 设备和AVPLAY</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730164615.svg" alt="HI_MPI_AVPLAY_Create.__avplay_mpi_avplay_c" /></p><p>MCE实现了启动过程画面的平滑切换</p><h3 id="ir">IR</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153646.png" alt="image-20210730153645198" /></p><p>驱动层</p><p>负责完成红外模块的中断处理，在底半部中遍历所有协议并调用 match 函数来判定当前收到的红外帧属于哪种协议。如果没有匹配，则丢弃当前帧。完成最顶层的错误处理：如果当前帧当前时刻还不能被解析，则会等待大约 200ms 之后再次尝试，如果失败，则丢弃当前帧。</p><p>协议适配层</p><p>完成各个协议的初始化工作，向上提供遍历协议的接口，向下提供容纳协议描述符的存储空间。</p><p>协议处理层</p><p>协议处理层完成判定：由从某个 symbol 开始的一连串 symbol 是不是符合本协议的一 帧。在判定某一帧符合本协议的前提条件下，完成一帧 symbol 的解析，将对应的键值解析出来。如果在解析过程中出错，或者判定是本协议的帧，但无法解析时，完成错误处理。</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153556.png" alt="image-20210730153555165" /></p><p>​ <img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153604.png" alt="image-20210730153602261" /></p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153611.png" alt="image-20210730153609651" /></p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153623.png" alt="image-20210730153621679" /></p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153630.png" alt="image-20210730153628969" /></p><h1 id="44-sample_mosaic分析">4.4 Sample_mosaic分析</h1><h2 id="应用层调用">应用层调用</h2><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153315.png" alt="image-20210730153312737" /></p><p>上图是部分截图，完整大的原图见目录中svg文件</p><p>valgrind –tool=callgrind ./sample_mosaic 1080P.h264 h264</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153400.svg" alt="samplemosaic-callgrind-all" /></p><h2 id="系统调用">系统调用</h2><p>Strace分析</p><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730153300.png" alt="image-20210730153249414" /></p><h1 id="5小结">5:小结：</h1><p>海思MPI驱动其实就是在标准linux驱动基础之上封装了一层，增加了log，proc，内存管理（映射，链表）功能。MPI是在标准linux驱动基础上封装了DVR常用外围逻辑接口，并且统一并简化了接口操作方式，原来各个外围子系统操作方式差别很大，不同实现框架，实现方式使用方法也不一样（如VI，VO，AI/AO，VPSS，如果自己用标准linux子系统实现要复杂得多）。</p><p>应用层MPI接口是在MPI驱动基础上再次封装了一层，封装了驱动的调用，配置等操作，在驱动功能的基础上进一步封装完成了一些简单的业务功能接口，方便了用户的使用。UNF就是在MPI基础上增加了业务逻辑封装，把常用的业务逻辑封装成接口，大大方便用户的应用程序开发。</p><h1 id="51-unf相对标准内核模块区别">5.1 UNF相对标准内核模块区别</h1><h2 id="511-proc读写调试">5.1.1 Proc读写调试。</h2><p>实时查询运行状态，修改设置。通用的proc目录、文件创建销毁有通用接口。读写proc文件在每个内核模块中有单独实现。</p><h2 id="512-内核空间往应用空间写文件">5.1.2 内核空间往应用空间写文件</h2><p>方便调试，Dump内核数据到用户控件方便定位Bug。</p><div lang="c" class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">HI_DRV_FILE_Open</span>
<span class="n">filp_open</span>
<span class="n">HI_DRV_FILE_Close</span>
<span class="err">​</span>    <span class="n">filp_close</span>
<span class="n">HI_DRV_FILE_Read</span>
<span class="err">​</span>    <span class="n">pFile</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span>
<span class="n">HI_DRV_FILE_Write</span>
<span class="err">​</span>    <span class="n">pFile</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span>
<span class="n">HI_DRV_FILE_Lseek</span>
<span class="err">​</span>    <span class="n">vfs_llseek</span>
</pre></table></code></div></div><h2 id="513log管理">5.1.3Log管理</h2><p>日志打印分级，实时修改。如何实现的见前面章节。</p><h2 id="514内存映射">5.1.4内存映射</h2><p>物理地址，虚拟地址映射关系管理，小块内存使用kmalloc申请，大块内存使用dma_alloc_from_contiguous申请。</p><p>使用内核链表管理。</p><p>打印到proc，log模块中，实时查看运行状态，内存。</p><p>方便查找，打印。</p><p>在多个内核共享数据也是这样实现的。</p><h1 id="52代码分析方法">5.2代码分析方法</h1><h2 id="521-查看代码静态分析应用层驱动层实现方法">5.2.1 查看代码，静态分析应用层，驱动层实现方法</h2><h2 id="522-图示静态分析函数调用关系">5.2.2 图示静态分析函数调用关系.</h2><p>Cflow, dot</p><h2 id="523-图示动态分析函数调用关系库函数系统调用内核调用">5.2.3 图示动态分析函数调用关系：库函数，系统调用，内核调用</h2><p>​ Ltrace, strace, valgrind, perf</p><p>具体分析方法，使用工具见前面章节。</p><h1 id="参考文档">参考文档：</h1><ol><li>03-HMS 开发指南.pdf<li>HiSTBAndroidV600R001C00SPC060_cn\document\01-Development Guide<li>HiMPP V3.0 媒体处理软件开发参考.pdf<li>HiSTBAndroidV600R001C00SPC060_cn\document\01-Development Guide<li>3798m SDK 代码<li>HMS API Development Reference.chm<li>HiSTBAndroidV600R001C00SPC060_cn\document\01-Development Guide\09-API Reference</ol><hr /><h1 id="赞赏作者">赞赏作者</h1><h3 id="支付宝赞赏">支付宝赞赏</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/2620210726175412.png" alt="支付宝" /></p><h3 id="微信赞赏">微信赞赏</h3><p><img data-proofer-ignore data-src="https://images.weserv.nl?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/2620210726180056.png" alt="image-20210726180053280" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="iconfont icon-FolderOpen-1 mr-1"></i> <a href='/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/'>嵌入式</a>, <a href='/categories/%E7%B3%BB%E7%BB%9F/'>系统</a></div><div class="post-tags"> <i class="iconfont icon-tag mr-1"></i> <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/" class="post-tag no-text-decoration" >嵌入式</a> <a href="/tags/%E6%B5%B7%E6%80%9D/" class="post-tag no-text-decoration" >海思</a> <a href="/tags/%E7%B3%BB%E7%BB%9F/" class="post-tag no-text-decoration" >系统</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/driver/" class="post-tag no-text-decoration" >Driver</a> <a href="/tags/3798m/" class="post-tag no-text-decoration" >3798M</a> <a href="/tags/3531a/" class="post-tag no-text-decoration" >3531a</a> <a href="/tags/mpp/" class="post-tag no-text-decoration" >MPP</a> <a href="/tags/unf/" class="post-tag no-text-decoration" >UNF</a> <a href="/tags/kernel/" class="post-tag no-text-decoration" >Kernel</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=海思MPP&UNF构架源代码级分析 - 夜法之书&url=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="iconfont icon-twitter"></i> </a> <a href="https://lineit.line.me/share/ui?url=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/&text=海思MPP&UNF构架源代码级分析 - 夜法之书" data-toggle="tooltip" data-placement="top" title="Line" target="_blank" rel="noopener" aria-label="Line"> <i class="iconfont icon-13"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=海思MPP&UNF构架源代码级分析 - 夜法之书&u=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="iconfont icon-facebook"></i> </a> <a href="https://telegram.me/share?text=海思MPP&UNF构架源代码级分析 - 夜法之书&url=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="iconfont icon-telegram"></i> </a> <a href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/&title=海思MPP&UNF构架源代码级分析 - 夜法之书" data-toggle="tooltip" data-placement="top" title="QQ" target="_blank" rel="noopener" aria-label="QQ"> <i class="iconfont icon-QQ"></i> </a> <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/&title=海思MPP&UNF构架源代码级分析 - 夜法之书" data-toggle="tooltip" data-placement="top" title="QQ 空间" target="_blank" rel="noopener" aria-label="QQ 空间"> <i class="iconfont icon-qzone"></i> </a> <a href="http://s.share.baidu.com/?click=1&url=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/&uid=0&to=tieba&type=text&pic=&title=海思MPP&UNF构架源代码级分析 - 夜法之书&key=&desc=&comment=&relateUid=&searchPic=0&sign=on" data-toggle="tooltip" data-placement="top" title="贴吧" target="_blank" rel="noopener" aria-label="贴吧"> <i class="iconfont icon-tieba"></i> </a> <a href="http://service.weibo.com/share/share.php?title=海思MPP&UNF构架源代码级分析 - 夜法之书&url=https://blog2.17lai.fun//posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/" data-toggle="tooltip" data-placement="top" title="微博" target="_blank" rel="noopener" aria-label="微博"> <i class="iconfont icon-weibo"></i> </a> <i class="iconfont icon-link small" onclick="copyLink('', '链接已复制！')" data-toggle="tooltip" data-placement="top" title="分享链接"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Gitlab%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B%E5%AE%8C%E5%85%A8%E7%89%88/">Gitlab的安装及使用教程完全版</a><li><a href="/posts/qnap-%E4%BF%AE%E6%94%B9%E5%A5%97%E4%BB%B6%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F/">QNAP 修改应用启动顺序</a><li><a href="/posts/%E4%BD%BF%E7%94%A8jeckett,sonarr,iyuu,qt,emby%E6%89%93%E9%80%A0%E5%85%A8%E8%87%AA%E5%8A%A8%E8%BF%BD%E5%89%A7%E6%B5%81%E7%A8%8B/">使用jeckett,sonarr,iyuu,qt,emby打造全自动追剧流程</a><li><a href="/posts/%E5%AE%9D%E5%A1%94linux%E9%9D%A2%E6%9D%BF%E9%87%8D%E5%90%AF&%E9%87%8D%E7%BD%AE%E7%AD%89%E9%85%8D%E7%BD%AE%E6%95%B4%E5%90%88/">宝塔linux面板重启、重置等命令整合</a><li><a href="/posts/%E6%B5%B7%E6%80%9DMPP&UNF%E6%9E%84%E6%9E%B6%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BA%A7%E5%88%86%E6%9E%90/">海思MPP&UNF构架源代码级分析</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/qnap/">QNAP</a> <a class="post-tag" href="/tags/gitlab/">Gitlab</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/pt/">PT</a> <a class="post-tag" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a> <a class="post-tag" href="/tags/3531a/">3531a</a> <a class="post-tag" href="/tags/bt/">BT</a> <a class="post-tag" href="/tags/crack/">Crack</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">目录</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/%E8%A7%82%E7%9C%8B%E5%8D%9A%E5%AE%A2%E9%9C%80%E7%9F%A5/"><div class="card-body"> <span class="timeago small" >08-19<i class="unloaded">2021-08-19T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>观看博客需知</h3><div class="text-muted small"><p> 博客需知 观看本博客，您最好了解以下几个问题，强烈推荐在浏览其它网页之前观看本文。 图床 关于本blog，图床一般使用github 已经配置了图像CDN加速，可能加载较慢，如果图片还是未显示请自行代理解决。 博客主题 本blog主题目前定为，技术，健康，健身，docker，qnap，理财等等。 评论系统 评论系统采用waline 关于我 订阅本Bl...</p></div></div></a></div><div class="card"> <a href="/posts/3G&4G&IOT%E6%A8%A1%E5%9D%97%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%A7%BB%E6%A4%8D/"><div class="card-body"> <span class="timeago small" >07-30<i class="unloaded">2021-07-30T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>3G,4G,Wifi选型需求分析及技术简介</h3><div class="text-muted small"><p> 3G,4G,Wifi选型需求分析及技术简介 文章写了好多年了，只在一个网站发布过PDF版本。行业内应该很多人看过这个。 关于本blog，图床一般使用github，已经配置了CDN，如果图片还是未显示请自行代理解决 原创声明警告，文章禁止转载，禁止发布到其它任何网站，可以接受约稿。 用户需求分析 减少布线，或有的地方很难布线...</p></div></div></a></div><div class="card"> <a href="/posts/Debian-Lenny-Laptop%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/"><div class="card-body"> <span class="timeago small" >08-18<i class="unloaded">2021-08-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Debian Lenny Laptop安装记录</h3><div class="text-muted small"><p> Debian Lenny Laptop安装记录 这是一篇非常有历史的文章了，写了十多年了。只在个人google doc中公开共享过。时至今日，参考价值还是非常大的。 目的是完全采用Linux系统来完成所有工作。 这篇文章当年我写了一周，每个步骤都是实践后仔细记录的。 摘 要 ​ 在现在电子信息化社会中，网络越来越重要，各种电子商务，网上银行，网络交友，SNS社区等越来...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E5%8F%8B%E9%93%BE%E4%BA%A4%E6%8D%A2/" class="btn btn-outline-primary" prompt="上一篇"><p>友链交换</p></a> <a href="/posts/%E5%AE%9D%E5%A1%94linux%E9%9D%A2%E6%9D%BF%E9%87%8D%E5%90%AF&%E9%87%8D%E7%BD%AE%E7%AD%89%E9%85%8D%E7%BD%AE%E6%95%B4%E5%90%88/" class="btn btn-outline-primary" prompt="下一篇"><p>宝塔linux面板重启、重置等命令整合</p></a></div><div id="waline"></div><script> Waline({ el: '#waline', serverURL: 'https://17laiblog.vercel.app/', emoji: [ 'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq', 'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba', 'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-emoji', 'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili', ], dark: 'html[mode="dark"]', avatar: 'mp', placeholder: '雁过留声，人过留名，说点什么吧！', }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://blog.17lai.fun/">17lai.fun</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/qnap/">QNAP</a> <a class="post-tag" href="/tags/gitlab/">Gitlab</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/pt/">PT</a> <a class="post-tag" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a> <a class="post-tag" href="/tags/3531a/">3531a</a> <a class="post-tag" href="/tags/bt/">BT</a> <a class="post-tag" href="/tags/crack/">Crack</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="iconfont icon-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://blog2.17lai.fun/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="iconfont icon-folder"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="iconfont icon-tag"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-EWP4K8DJTE"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-EWP4K8DJTE'); }); </script>
